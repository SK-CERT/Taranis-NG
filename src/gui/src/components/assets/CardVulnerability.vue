<template>
    <v-container v-bind="UI.CARD.CONTAINER">
        <v-row>
            <v-col :class="UI.CLASS.card_offset">
                <v-hover v-slot="{hover}">
                    <v-card v-bind="UI.CARD.HOVER" :elevation="hover ? 12 : 2" @click.stop="cardItemToolbar">
                        <!--CONTENT-->
                        <v-layout v-bind="UI.CARD.LAYOUT" :class="'status ' + itemStatus">
                            <v-row v-bind="UI.CARD.ROW.CONTENT">
                                <v-col :style="UI.STYLE.card_tag">
                                    <v-icon center>{{itemStatusIcon}}</v-icon>
                                </v-col>
                                <v-col>
                                    <div class="grey--text">{{$t('card_item.title')}}</div>
                                    <span>{{card.report_item.title}}</span>
                                </v-col>
                                <v-col>
                                    <div class="grey--text">{{$t('card_item.created')}}</div>
                                    <span>{{card.report_item.created}}</span>
                                </v-col>

                                <!--HOVER TOOLBAR-->
                                <v-col :style="UI.STYLE.card_hover_toolbar">
                                    <v-row v-if="editAllowed() && hover" v-bind="UI.CARD.TOOLBAR.COMPACT" :style="UI.STYLE.card_toolbar">
                                        <v-col v-bind="UI.CARD.COL.TOOLS">
                                            <v-btn icon @click.stop="cardItemToolbar('solve')">
                                                <v-icon color="accent">{{actionIcon}}</v-icon>
                                            </v-btn>
                                        </v-col>
                                    </v-row>
                                </v-col>
                            </v-row>
                        </v-layout>
                    </v-card>
                </v-hover>
            </v-col>
        </v-row>
    </v-container>
</template>

<script>
import { solveVulnerability } from '@/api/assets'
import AuthMixin from '@/services/auth/auth_mixin'
import Permissions from '@/services/auth/permissions'

export default {
  name: 'CardVulnerability',
  mixins: [AuthMixin],
  props: {
    card: Object,
    asset: Object
  },
  data: () => ({
    toolbar: false
  }),
  computed: {
    itemStatus () {
      if (this.card.solved) {
        return 'completed'
      } else {
        return 'alert'
      }
    },
    itemStatusIcon () {
      if (this.card.solved) {
        return 'mdi-check-circle-outline'
      } else {
        return 'mdi-alert-outline'
      }
    },
    actionIcon () {
      if (this.card.solved) {
        return 'mdi-alert-circle-outline'
      } else {
        return 'mdi-checkbox-marked-circle-outline'
      }
    }
  },
  methods: {
    editAllowed () {
      return this.checkPermission(Permissions.MY_ASSETS_CREATE)
    },
    itemClicked (data) {
      this.$root.$emit('show-vulnerability-detail', data.report_item)
    },
    solveClicked () {
      solveVulnerability({
        asset_id: this.asset.id,
        report_item_id: this.card.report_item.id,
        solved: !this.card.solved
      }).then(() => {
        this.card.solved = !this.card.solved
      })
    },
    cardItemToolbar (action) {
      switch (action) {
        case 'solve':
          this.solveClicked()
          break

        default:
          this.toolbar = false
          this.itemClicked(this.card)
          break
      }
    }
  }
}
</script>
